<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>灵创党建</title>
    <link rel="shortcut icon" href="../../static/img/favicon.ico">
    <link rel="stylesheet" type="text/css" href="../../static/mobile/css/public.css">
    <link rel="stylesheet" type="text/css" href="../../static/mobile/css/index.css">
</head>
<style>
    .task_box{
        display: flex;
        justify-content: space-between;
        padding: 10px;
        margin-bottom: 10px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .task_operation{
        display: flex;
        flex-direction: column;
        gap: 5px;
        justify-content: center;
    }
    .task_title{
        margin: 0 0 4px 5px;
        font-weight: bold;
        white-space: nowrap;
        text-overflow: ellipsis; 
        word-break: break-all;
        overflow: hidden;
    }
    .task_info{
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
        margin-right: 10px;
    }
    .task_status{
        background-color: #8e1c11;
        color: white;
        border-radius: 6px;
        font-size: 14px;
        padding: 0 2px;
        height: 24px;
        width: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .task_detail_btn{
        background-color: #4d9a39;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        padding: 4px 10px;
        cursor: pointer;
    }
    .task_detail_btn:hover{
        background-color: #3c8828;
    }
    .task_review_btn{
        background-color: #dc7b2d;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        padding: 4px 10px;
        cursor: pointer;
    }
    .task_review_btn:hover{
        background-color: #c86e23;
    }
    .task_complete_btn{
        background-color: #c42a18;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        padding: 4px 10px;
        cursor: pointer;
    }
    .task_complete_btn:hover {
        background-color: #b52020;
    }
    .disabled{
        background-color: #DADADA !important;
        color: #3f3f3f !important;
        cursor: not-allowed !important;
    }
    .disabled:hover {
        background-color: #DADADA !important;
    }
    .task_list_container {
        display: flex;
        flex-direction: column;
        padding: 10px;
    }
    .empty_state {
        text-align: center;
        padding: 40px 0;
        color: #999;
    }
    .status-processing {
        background-color: #2196F3;
    }
    .status-completed {
        background-color: #4CAF50;
    }
    .status-rejected {
        background-color: #999;
    }
</style>
<body style="background-color: #FAFAFA">
<p id="URL" class="hide">{{URL}}</p>
<div class="top_nav" style="margin-bottom: 10px">
    <svg id="back_btn" transform="rotate(180 0 0)" width="8.43994140625" height="14.68994140625" viewBox="0 0 8.43994140625 14.68994140625"><path d="M0.289942 13.04L6.11994 7.35L0.289942 1.65C0.107385 1.45918 -5.81741e-05 1.21559 -5.81741e-05 0.949999C-5.81741e-05 0.410583 0.420541 0 0.959941 0C1.22555 0 1.45566 0.0874033 1.62994 0.27L8.10994 6.61C8.33402 6.82579 8.43994 7.0678 8.43994 7.35C8.43994 7.63219 8.33402 7.8642 8.10994 8.08L1.62994 14.42C1.45566 14.6026 1.22555 14.69 0.959941 14.69C0.420541 14.69 -5.81741e-05 14.2778 -5.81741e-05 13.73C-5.81741e-05 13.4644 0.107385 13.2226 0.289942 13.04Z" fill="#FFFFFF" ></path></svg>
    <p class="title">任务管理</p>
</div>

<div class="task_list_container" id="task_list">
    <div class="loading">加载中...</div>
</div>

</body>
<script src="../../static/sdk/jquery.min.js"></script>
<script src="../../static/mobile/js/public.js" defer></script>
<script src="../../static/mobile/js/home.js" defer></script>
<script>
    $(document).ready(function() {
        const URL = $('#URL').text();
        let taskData = []; // 存储从后端获取的任务数据
        
        // 获取任务数据
        function fetchTaskData() {
            $.ajax({
                url: URL + "/activity/query",
                xhrFields: {withCredentials: true},
                type: "POST",
                dataType: "json",
                data: {
                    'uid': localStorage.getItem('uid'),
                    'mode': 'private',
                },
                success: function (resp) {
                    if (resp.code === 1000) {
                        taskData = resp.data;
                        sessionStorage.setItem('activityData', JSON.stringify(taskData));
                        renderTaskList();
                    }
                },
                error: function () {
                    alert("连接失败：无法连接至服务器，请联系站长或稍后再试。");
                    $('#task_list').html('<div class="empty_state">加载失败，请重试</div>');
                }
            });
        }
        
        // 渲染任务列表
        function renderTaskList() {
            const taskListContainer = $('#task_list');
            taskListContainer.empty();
            
            if (taskData.length === 0) {
                taskListContainer.html('<div class="empty_state">暂无任务数据</div>');
                return;
            }
            
            // 为每个任务创建HTML并添加到容器中
            taskData.forEach(item => {
                // 根据任务状态获取状态文本和样式
                let statusText = '未知';
                let statusClass = '';
                
                switch(item.status) {
                    case 1:
                        statusText = '待审核';
                        statusClass = 'task_status';
                        break;
                    case 2:
                        statusText = '进行中';
                        statusClass = 'task_status status-processing';
                        break;
                    case 3:
                        statusText = '已完成';
                        statusClass = 'task_status status-completed';
                        break;
                    case 4:
                        statusText = '审核拒绝';
                        statusClass = 'task_status status-rejected';
                        break;
                }
                
                // 创建任务盒子
                const taskBox = $('<div class="box sd0 task_box"></div>');
                
                // 创建任务信息部分
                const taskInfo = $('<div class="task_info"></div>');
                
                // 添加任务标题和状态
                const titleContainer = $('<div style="display: flex; align-items: center;"></div>');
                titleContainer.append(`<div class="${statusClass}">${statusText}</div>`);
                titleContainer.append(`<p class="task_title" data-full-title="${item.title || ''}">${truncateTitle(item.title || '')}</p>`);
                taskInfo.append(titleContainer);
                
                // 添加任务其他信息
                taskInfo.append(`<div>发起时间：<p class="task_date">${item.created_time || '-'}</p></div>`);
                taskInfo.append(`<div>任务类型：<p class="task_type">${item.task_type || '-'}</p></div>`);
                taskInfo.append(`<div>执行频次：<p class="task_frequency">${item.frequency || '-'}</p></div>`);
                
                // 创建任务操作部分
                const taskOperation = $('<div class="task_operation" style="gap: 5px; justify-content: center"></div>');
                
                // 添加详情按钮
                taskOperation.append(`<div class="task_detail_btn" data-id="${item.id}" data-type="${item.type}">详情</div>`);
                
                // 根据状态添加审核按钮（只有待审核状态才有）
                if (item.status == 1) {
                    taskOperation.append(`<div class="task_review_btn" data-id="${item.id}" data-type="${item.type}">审核</div>`);
                } else {
                    taskOperation.append('<div class="task_review_btn disabled">审核</div>');
                }
                
                // 根据状态和是否有附件添加完成按钮
                if (item.attachment_name && item.status == 2) {
                    taskOperation.append(`<div class="task_complete_btn" data-id="${item.id}" data-attachment="${item.attachment_name}" data-task-id="${item.id}">处理</div>`);
                } else {
                    taskOperation.append('<div class="task_complete_btn disabled">处理</div>');
                }
                
                // 组装任务盒子
                taskBox.append(taskInfo);
                taskBox.append(taskOperation);
                
                // 添加到容器
                taskListContainer.append(taskBox);
            });
            
            // 绑定按钮事件
            bindTaskButtons();
        }
        
        // 截断标题函数，最多12个中文字符
        function truncateTitle(title) {
            if (!title || title.length <= 12) {
                return title;
            }
            return title.substring(0, 12) + '...';
        }
        
        // 绑定任务按钮事件
        function bindTaskButtons() {
            // 绑定详情按钮事件
            $('.task_detail_btn').click(function() {
                const id = $(this).data('id');
                const type = $(this).data('type');
                // 获取完整的数据
                const allData = JSON.parse(sessionStorage.getItem('activityData') || '[]');
                const item = allData.find(item => item.id === id && item.type === type);
                
                if (item) {
                    // 调用统一的详情显示函数（如果存在）
                    if (typeof window.showTaskDetail === 'function') {
                        showTaskDetail(item);
                    } else {
                        // 简单的详情显示
                        let detail = `任务详情：\n标题：${item.title || '-'}\n类型：${item.task_type || '-'}\n状态：${getStatusText(item.status)}\n发起时间：${item.created_time || '-'}\n执行频次：${item.frequency || '-'}`;
                        alert(detail);
                    }
                }
            });
            
            // 绑定审核按钮事件
            $('.task_review_btn:not(.disabled)').click(function() {
                const taskId = $(this).data('id');
                const type = $(this).data('type');
                
                // 显示包含三个选项的审核对话框
                const reviewAction = prompt('请输入审核操作编号：\n1. 同意审核\n2. 拒绝审核\n3. 取消操作\n\n默认：取消操作');
                
                if (reviewAction === '1') {
                    // 用户选择同意审核
                    reviewTask(taskId, 2);
                } else if (reviewAction === '2') {
                    // 用户选择拒绝审核
                    reviewTask(taskId, 4);
                }
            });
            
            // 绑定完成按钮事件
            $('.task_complete_btn:not(.disabled)').click(function() {
                const attachmentName = $(this).data('attachment');
                const taskId = $(this).data('id');
                
                // 检查是否有openAddRecordModal函数
                if (typeof window.openAddRecordModal === 'function') {
                    // 打开"添加党员发展"的模态框
                    openAddRecordModal(1, '党员发展');
                    // 延迟一下，确保模态框已经渲染
                    setTimeout(function() {
                        // 查找任务选择下拉框
                        const taskSelect = document.getElementById('task-select');
                        if (taskSelect) {
                            // 查找匹配附件名称的任务选项
                            const options = Array.from(taskSelect.options);
                            let found = false;
                            for (let option of options) {
                                // 使用includes进行模糊匹配
                                if (option.text.includes(attachmentName) || option.value === taskId) {
                                    option.selected = true;
                                    // 触发change事件以加载任务详情
                                    const event = new Event('change');
                                    taskSelect.dispatchEvent(event);
                                    // 禁用下拉框
                                    taskSelect.disabled = true;
                                    found = true;
                                    break;
                                }
                            }
                            // 如果没找到，尝试遍历所有select元素查找附件名称匹配项
                            if (!found) {
                                const allSelects = document.querySelectorAll('select');
                                for (let select of allSelects) {
                                    const selectOptions = Array.from(select.options);
                                    for (let option of selectOptions) {
                                        if (option.text.includes(attachmentName) || option.value === taskId) {
                                            option.selected = true;
                                            select.disabled = true;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }, 100);
                } else {
                    alert('去完成功能暂不可用');
                }
            });
        }
        
        // 审核任务函数
        function reviewTask(taskId, status) {
            // 显示加载提示
            alert('处理中...');
            
            // 发送审核请求
            $.ajax({
                url: URL + '/activity/review_task',
                xhrFields: {withCredentials: true},
                type: 'POST',
                data: {
                    task_id: taskId,
                    status: status,
                    uid: localStorage.getItem('uid')
                },
                success: function(resp) {
                    if (resp.code === 1000) {
                        alert('审核成功');
                        // 重新获取数据并渲染表格
                        fetchTaskData();
                    } else {
                        alert('审核失败：' + resp.message);
                    }
                },
                error: function() {
                    alert('审核请求失败，请重试');
                }
            });
        }
        
        // 获取状态文本
        function getStatusText(status) {
            switch(status) {
                case 1: return '待审核';
                case 2: return '进行中';
                case 3: return '已完成';
                case 4: return '审核拒绝';
                default: return '未知';
            }
        }
        
        // 返回按钮事件
        $('#back_btn').click(function() {
            window.history.back();
        });
        // 页面加载时获取任务数据
        fetchTaskData();
    });
</script>
</html>